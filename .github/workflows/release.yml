# Automated PyPI Release Workflow
#
# Purpose:
#   Automatically releases the package to PyPI when code is merged to master.
#   Runs full test suite, auto-increments patch version, creates Git tags,
#   generates GitHub releases, and publishes to PyPI using trusted publishing.
#
# Triggers:
#   - Push to master branch (after PR merge)
#   - Manual workflow dispatch
#
# Skip Release:
#   Add '[skip release]' to commit message to prevent automatic release.
#
# Prerequisites:
#   - PyPI trusted publishing configured (see README)
#   - GitHub environment 'release' created
#   - Initial version tag exists (e.g., v0.1.0)
#   - Repository secret 'GH_PAT' configured with a Personal Access Token that has:
#     * 'contents: write' permission to create tags and releases
#     * Ability to bypass tag creation restrictions (if rulesets are enabled)
#   - Repository rulesets (if any) must allow tag creation by the workflow actor
#     or the PAT must have bypass permissions

name: Release to PyPI
permissions:
  contents: write
  id-token: write
on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
      - 'pyproject.toml'
      - 'requirements.txt'
  workflow_dispatch:
jobs:
  deploy:
    if: (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip release]')) || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: write
      id-token: write
    steps:
        - name: Checkout code
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
            fetch-depth: 0
            token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
            # GH_PAT is required if repository rulesets restrict tag creation.
            # The PAT must have 'contents: write' and bypass tag protection rules.

        - name: Set up uv
          uses: astral-sh/setup-uv@3b9817b1bf26186f03ab8277bab9b827ea5cc254 # v3.2.0
          with:
            version: "0.8.3" # Sync with pyproject.toml

        - name: "Set up Python"
          uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
          with:
            python-version: 3.13

        - name: Setup dependencies
          run: |
            uv python pin 3.13
            uv export --no-managed-python --no-group doc --resolution highest > /tmp/ci-requirements.txt
            uv pip install --system -r /tmp/ci-requirements.txt
            rm /tmp/ci-requirements.txt

        - name: Run tests
          run: |
            uv run --frozen pytest --cov --cov-report=term-missing

        - name: Get latest tag
          id: get_tag
          run: |
            git fetch --tags
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "Latest tag: $LATEST_TAG"

        - name: Determine next version
          id: next_version
          run: |
            LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
            VERSION=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
            NEXT_PATCH=$((PATCH + 1))
            NEXT_VERSION="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
            NEXT_VERSION_CLEAN="${MAJOR}.${MINOR}.${NEXT_PATCH}"
            echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
            echo "next_version_clean=$NEXT_VERSION_CLEAN" >> $GITHUB_OUTPUT
            echo "Next version: $NEXT_VERSION"

        - name: Create and push tag
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a ${{ steps.next_version.outputs.next_version }} -m "Release ${{ steps.next_version.outputs.next_version }}"
            if ! git push origin ${{ steps.next_version.outputs.next_version }} 2>&1; then
              echo "::error::Failed to push tag. This may be due to repository rulesets restricting tag creation."
              echo "::error::Solution: Create a Personal Access Token (PAT) with contents:write permission"
              echo "::error::and bypass privileges, then add it as a repository secret named GH_PAT."
              echo "::error::See: https://github.com/${{ github.repository }}/settings/rules"
              exit 1
            fi

        - name: Create GitHub Release
          uses: softprops/action-gh-release@e7a8f85e1c67a31e6ed99a94b41bd0b71bbee6b8 # v2.2.0
          with:
            tag_name: ${{ steps.next_version.outputs.next_version }}
            name: Release ${{ steps.next_version.outputs.next_version }}
            generate_release_notes: true

        - name: Build package
          env:
            SETUPTOOLS_SCM_PRETEND_VERSION: ${{ steps.next_version.outputs.next_version_clean }}
          run: |
            uv build

        - name: Publish to PyPI
          run: |
            uv publish --trusted-publishing always